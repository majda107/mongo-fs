@page "/"
@page "/{Id}"
@page "/{Id}/{FolderId}"
@using MongoDB.Bson
@inject MongoService _ms;

<div class="mongofs-layout">
    <section class="mongofs-header">
        <h1>MongoFS</h1>
        <span class="subheader">FileSystem to save ‘em all.</span>
    </section>

    <section class="statistics">
        <div class="statistics-header">
            <h2>Statistics</h2>
            <ul>
                <li>Files: 42</li>
                <li>Folders: 14</li>
                <li>Drives: 4</li>
            </ul>
        </div>
        <ul>
            <li>Running on <b>ASP.NET 5</b></li>
            <li>Stored in <b>MongoDB</b></li>
        </ul>
        <span>Crafted with ❤️ by️ <b>Marián Trpkoš</b></span>
    </section>

    <section class="mongofs-drive">
        <DriveDetail Drive="@this.drive"/>
    </section>

    <section class="drives">
        <DrivesDetail Selected="@Selected" Active="@this.drive"></DrivesDetail>
    </section>

    <section class="detail">
        <IFileDetail IFile="@this.selected"/>
    </section>

    <section class="files">
        <IFilesDetail Drive="@this.drive" Parent="@this.parent" ParentSelected="@ParentSelected" IFileSelected="@IFileSelected" Selected="@this.selected"/>
    </section>

    @* <a href="#new">Modal</a> *@
    @* <button onclick="window.location.href = '#new'">Trigger modal</button> *@

    <div class="overlay" id="new-drive">
        <form class="overlay-form">
            <h2>Create new drive</h2>

            <div class="overlay-form-control">
                <label>Name</label>
                <input type="text" placeholder="MajdaDrive"/>
            </div>

            <div class="overlay-form-control">
                <label>Capacity</label>
                <input type="number" placeholder="500"/>
            </div>

            <div class="overlay-form-buttons">
                <button class="success">Create!</button>
                <button type="button" onclick="window.location.hash = ''">Cancel</button>
            </div>
        </form>

        <button class="overlay-close" onclick="window.location.hash = ''">
            <img src="icons/cross.svg"/>
        </button>
    </div>
</div>

@code {

    [Parameter]
    public string Id { get; set; }

    [Parameter]
    public string FolderId { get; set; }


    private DriveModel drive = null;
    private FolderModel parent = null;
    private IFileModel selected = null;

    protected override async Task OnInitializedAsync()
    {
        if (ObjectId.TryParse(this.Id, out ObjectId parsedId))
        {
            this.drive = await this._ms.GetDrive(parsedId);
            this.StateHasChanged();
        }

        if (ObjectId.TryParse(this.FolderId, out ObjectId folder))
        {
            this.parent = await this._ms.GetDriveFolder(this.drive.Id, folder);
            this.StateHasChanged();
        }
    }

    private void Selected(DriveModel drive)
    {
        this.drive = drive;
        
        this.parent = null;
        this.selected = null;
        
        Console.WriteLine($"Drive {drive.Name} selected!");
        this.StateHasChanged();
    }

    private void ParentSelected(FolderModel parent)
    {
        this.parent = parent;
        this.selected = parent;
        this.StateHasChanged();
    }

    private void IFileSelected(IFileModel ifile)
    {
        this.selected = ifile;
        this.StateHasChanged();
    }

}